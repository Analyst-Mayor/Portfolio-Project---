--	SELECT columns from a table
--	WHERE to filter from
--	Logical operators: AND, OR, NOT
--	Filtering on strings, numbers, dates

	--WHERE to filter rows
SELECT ITIN_ID, ITIN_FARE, DESTINATION, PASSENGERS, ORIGIN
FROM [dbo].[Tickets]
WHERE ITIN_FARE > '200'

	--Logical operators: AND, OR, NOT
SELECT ITIN_ID, ITIN_FARE, DESTINATION, PASSENGERS, ORIGIN
FROM [dbo].[Tickets]
WHERE ITIN_FARE > '200' AND DESTINATION = 'DAB'

	--Logical operators: AND, OR, NOT
SELECT ITIN_ID, ITIN_FARE, DESTINATION, PASSENGERS, ORIGIN
FROM [dbo].[Tickets]
WHERE ITIN_FARE > '200' OR DESTINATION = 'DABI'

	--Logical operators: AND, OR, NOT
SELECT ITIN_ID, ITIN_FARE, DESTINATION, PASSENGERS, ORIGIN
FROM [dbo].[Tickets]
WHERE ITIN_FARE > '200.0' AND DESTINATION LIKE '%DA%'


SELECT ITIN_ID, 
TRY_CAST(ITIN_FARE AS DECIMAL(10,2)),
DESTINATION, PASSENGERS, ORIGIN
FROM [dbo].[Tickets]
WHERE TRY_CAST(ITIN_FARE AS DECIMAL(10,2)) > 200;


--ORDER BY
SELECT ITIN_ID, ITIN_FARE, DESTINATION, PASSENGERS, ORIGIN
FROM [dbo].[Tickets]
ORDER BY DESTINATION 


SELECT ITIN_ID, ITIN_FARE, DESTINATION, PASSENGERS, ORIGIN
FROM [dbo].[Tickets]
ORDER BY DESTINATION ASC

SELECT ITIN_ID, ITIN_FARE, DESTINATION, PASSENGERS, ORIGIN
FROM [dbo].[Tickets]
ORDER BY DESTINATION DESC

--Aliasing
SELECT ITIN_ID AS 'ID', ITIN_FARE AS 'PRICE', DESTINATION 'DEST', PASSENGERS AS 'PASS', ORIGIN AS 'ORIG'
FROM [dbo].[Tickets]
ORDER BY DESTINATION DESC


--Expression TO CREATE A NEW COLUMN
--+,-,/,*

WITH
TICKETS1 
AS(
	SELECT [ITIN_ID]
		  ,TRY_CAST([YEAR] AS INT) AS 'YEAR'
		  ,TRY_CAST([QUARTER] AS INT) AS 'QUARTER'
		  ,[ORIGIN]
		  ,[ORIGIN_COUNTRY]
		  ,[ORIGIN_STATE_ABR]
		  ,[ORIGIN_STATE_NM]
		  ,CAST(TRY_CAST([ROUNDTRIP] AS DECIMAL(10,2)) AS INT) AS 'ROUNDTRIP'
		  ,[REPORTING_CARRIER]
		  ,CAST(TRY_CAST([PASSENGERS] AS DECIMAL(10,2)) AS INT) AS 'PASSENGERS'
 		  ,TRY_CAST([ITIN_FARE] AS DECIMAL(10,2)) AS 'ITIN_FARE'
 		  ,[DESTINATION]
		--INTO [dbo].TICKETS1
	  FROM [Training 02].[dbo].[Tickets]
),
Airport_Codes1
AS (
SELECT [TYPE]
      ,[NAME]
      ,[CONTINENT]
      ,[ISO_COUNTRY]
      ,[MUNICIPALITY]
      ,[IATA_CODE]
	  ,TRY_CAST([ELEVATION_FT] AS DECIMAL(10,2)) AS 'ELEVATION_FT'
      ,TRIM('"' FROM [COORDINATES]) AS 'COORDINATES'
	--INTO [dbo].Airport_Codes1
  FROM [Training 02].[dbo].[Airport_Codes]
  --ORDER BY [IATA_CODE] DESC
),

EXPRESSTICKETS AS (
--Expression TO CREATE A NEW COLUMN
--+,-,/,*
SELECT TOP 100
ITIN_ID, 
ITIN_FARE, 
DESTINATION, 
PASSENGERS, 
ORIGIN,
ITIN_FARE + (ITIN_FARE * 0.10) 'FARE WITH 10%'
FROM TICKETS1 )

SELECT [TYPE] ,[NAME] ,[CONTINENT] ,[ISO_COUNTRY] ,[MUNICIPALITY] ,[IATA_CODE] ,[COORDINATES], [ELEVATION_FT],
	   [ELEVATION_FT] * 03048 AS 'ELEVATION_M'
FROM Airport_Codes1 

--DISTINCT
SELECT DISTINCT [TYPE] FROM Airport_Codes1

SELECT [TYPE] FROM Airport_Codes1
GROUP BY [TYPE]


Aggregation & GROUP BY
--COUNT
SELECT * FROM [dbo].TICKETS1
SELECT COUNT (*) FROM [dbo].TICKETS1

--SUM
SELECT SUM(ITIN_FARE) AS 'TOTAL SALE', PASSENGERS
 FROM [dbo].TICKETS1
GROUP BY PASSENGERS

--AVG
SELECT AVG(ITIN_FARE) AS 'TOTAL SALE'
 FROM [dbo].TICKETS1
GROUP BY ITIN_ID

SELECT AVG(ITIN_FARE) AS 'TOTAL SALE', ITIN_ID
 FROM [dbo].TICKETS1
GROUP BY ITIN_ID

--MAX
SELECT MAX(ITIN_FARE) AS 'TOTAL SALE'
 FROM [dbo].TICKETS1


SELECT MAX(ITIN_FARE) AS 'TOTAL SALE', ITIN_ID
 FROM [dbo].TICKETS1
GROUP BY ITIN_ID
ORDER BY MAX(ITIN_FARE) DESC


--MIN
SELECT MIN(ITIN_FARE) AS 'TOTAL SALE'
 FROM [dbo].TICKETS1

SELECT MIN(ITIN_FARE) AS 'TOTAL SALE', ITIN_ID
 FROM [dbo].TICKETS1
GROUP BY ITIN_ID
ORDER BY MIN(ITIN_FARE) DESC


SELECT MIN(ITIN_FARE) AS 'TOTAL SALE', ITIN_ID
 FROM [dbo].TICKETS1
 WHERE MIN(ITIN_FARE) > 500

 SELECT ITIN_FARE AS 'TOTAL SALE', ITIN_ID
 FROM [dbo].TICKETS1
 WHERE(ITIN_FARE) > 500


 --FILTER AFTER AGGREGATION

 --COUNT
SELECT COUNT (*),PASSENGERS FROM [dbo].TICKETS1 GROUP BY PASSENGERS
HAVING COUNT (*) > 200;

--SUM
SELECT SUM(ITIN_FARE) AS 'TOTAL SALE', PASSENGERS
 FROM [dbo].TICKETS1
GROUP BY PASSENGERS
HAVING SUM(ITIN_FARE) < 300


----INNER JOIN, LEFT JOIN, RIGHT JOIN, FULL OUTER JOIN


--IINER JOIN
SELECT TOP 5 * FROM [dbo].[TICKETS1]
SELECT TOP 5 * FROM [dbo].[Airport_Codes1]
SELECT TOP 5 * FROM [dbo].[Flights]

SELECT ITIN_ID, A.ORIGIN, A.DESTINATION, B.ORIGIN, B.DESTINATION, ORIGIN_STATE_ABR, TAIL_NUM, OP_CARRIER, ORIGIN_AIRPORT_ID
FROM [dbo].[TICKETS1] A
INNER JOIN [dbo].[Flights] B ON A.ORIGIN = B.ORIGIN AND A.DESTINATION = B.DEST_CITY_NAME


SELECT [TYPE], [NAME], IATA_CODE, ELEVATION_FT, ITIN_ID, ORIGIN, DESTINATION, ORIGIN, DESTINATION
FROM [dbo].[Airport_Codes1] C
JOIN [dbo].[TICKETS1] D ON C.IATA_CODE = D.ORIGIN  --AND C.IATA_CODE = D.DESTINATION


SELECT [TYPE], [NAME], [IATA_CODE], ELEVATION_FT, ITIN_ID, ORIGIN, DESTINATION, ORIGIN, DESTINATION
FROM [dbo].[Airport_Codes1] C
JOIN [dbo].[TICKETS1] D ON C.IATA_CODE = D.ORIGIN


--LEFT JOIN
SELECT ITIN_ID, A.ORIGIN, A.DESTINATION, B.ORIGIN, B.DESTINATION, ORIGIN_STATE_ABR, TAIL_NUM, OP_CARRIER, ORIGIN_AIRPORT_ID
FROM [dbo].[TICKETS1] A
LEFT JOIN [dbo].[Flights] B ON A.ORIGIN = B.ORIGIN AND A.DESTINATION = B.DEST_CITY_NAME


SELECT [TYPE], [NAME], [IATA_CODE], ELEVATION_FT, ITIN_ID, ORIGIN, DESTINATION, ORIGIN, DESTINATION
FROM [dbo].[Airport_Codes1] C
LEFT JOIN [dbo].[TICKETS1] D ON C.IATA_CODE = D.ORIGIN


SELECT * FROM [dbo].[Airport_Codes1]


--RIGHT JOIN
SELECT ITIN_ID, A.ORIGIN, A.DESTINATION, B.ORIGIN, B.DESTINATION, ORIGIN_STATE_ABR, TAIL_NUM, OP_CARRIER, ORIGIN_AIRPORT_ID
FROM [dbo].[TICKETS1] A
RIGHT JOIN [dbo].[Flights] B ON A.ORIGIN = B.ORIGIN AND A.DESTINATION = B.DEST_CITY_NAME


SELECT [TYPE], [NAME], [IATA_CODE], ELEVATION_FT, ITIN_ID, ORIGIN, DESTINATION, ORIGIN, DESTINATION
FROM [dbo].[Airport_Codes1] C
RIGHT JOIN [dbo].[TICKETS1] D ON C.IATA_CODE = D.ORIGIN



--FULL OUTER JOIN
SELECT ITIN_ID, A.ORIGIN, A.DESTINATION, B.ORIGIN, B.DESTINATION, ORIGIN_STATE_ABR, TAIL_NUM, OP_CARRIER, ORIGIN_AIRPORT_ID
FROM [dbo].[TICKETS1] A
FULL OUTER JOIN [dbo].[Flights] B ON A.ORIGIN = B.ORIGIN AND A.DESTINATION = B.DEST_CITY_NAME


SELECT [TYPE], [NAME], [IATA_CODE], ELEVATION_FT, ITIN_ID, ORIGIN, DESTINATION, ORIGIN, DESTINATION
FROM [dbo].[Airport_Codes1] C
FULL OUTER JOIN [dbo].[TICKETS1] D ON C.IATA_CODE = D.ORIGIN



--Session 2 / Day3: 
--Unoin, Unoin ALL, COCAT, CAOLESCE, ISNULL
SELECT TOP 5 * FROM [dbo].[TICKETS1]
SELECT TOP 5 * FROM [dbo].[Airport_Codes1]


--Union
SELECT ITIN_ID, ORIGIN, DESTINATION FROM [dbo].[TICKETS1]
UNION
SELECT CONTINENT, ISO_COUNTRY, IATA_CODE FROM [dbo].[Airport_Codes1]



--Union ALL
SELECT ITIN_ID, ORIGIN, DESTINATION FROM [dbo].[TICKETS1]
UNION ALL
SELECT CONTINENT, ISO_COUNTRY, IATA_CODE FROM [dbo].[Airport_Codes1]


--COCAT
SELECT TOP 5 * FROM [dbo].[Flights]

SELECT ORIGIN_CITY_NAME,DEST_AIRPORT_ID, CONCAT(ORIGIN_CITY_NAME, DEST_AIRPORT_ID) AS 'ORIGIN_CITY_NAME', DEP_DELAY, ARR_DELAY, CONCAT(DEP_DELAY, ARR_DELAY) 'DEST_CITY_NAME'
FROM [dbo].[Flights]


--COALESCE
SELECT TOP 5 * FROM [dbo].[TICKETS1]
SELECT TOP 5 * FROM [dbo].[Airport_Codes1]
SELECT TOP 5 * FROM [dbo].[Flights]

SELECT CONTINENT, ISO_COUNTRY, COALESCE(CONTINENT, ISO_COUNTRY) AS 'CONCAT_COUNTRY'
FROM [dbo].[Airport_Codes1]

SELECT ITIN_FARE, ROUNDTRIP, COALESCE(ITIN_FARE, ROUNDTRIP, 0) AS 'REMNULL'
FROM [dbo].[TICKETS1]
WHERE ITIN_FARE IS NULL


--ISNULL
SELECT ITIN_FARE, ROUNDTRIP, ISNULL(ITIN_FARE, ROUNDTRIP) AS 'CONCAT_COUNTRY'
FROM [dbo].[TICKETS1]
WHERE ITIN_FARE IS NULL



SELECT ITIN_FARE, ISNULL(ITIN_FARE, ROUNDTRIP) AS 'REMNULL'  
FROM [dbo].[TICKETS1]





--SUB QUERIES
SELECT TOP 10 * FROM[dbo].[TICKETS1]

--Itin_fare above avg fare price

select avg(itin_fare)
FROM[dbo].[TICKETS1]


select ITIN_ID, ORIGIN, DESTINATION, ITIN_FARE
FROM[dbo].[TICKETS1]
where ITIN_FARE > 408


  --Itin_fare above avg fare price

---using the avg
  select ITIN_ID, ORIGIN, DESTINATION, try_cast(ITIN_FARE as decimal (10,2))
FROM[dbo].[Tickets]
where try_cast(ITIN_FARE as decimal (10,2)) > (select avg(try_cast(ITIN_FARE as decimal (10,2))) from[dbo].[Tickets])


  ---top 10 origin with max fares
  select top 10 origin, max_fare from(
  select origin, max(try_cast(itin_fare as decimal (10,2))) as max_fare
  from [dbo].[Tickets]
  group by ORIGIN
  ) as max_fare_table
  order by max_fare desc

  ---compare itin_fare to the avg
  select itin_id, origin, destination, avg(try_cast(itin_fare as decimal (10,2))) from[dbo].[Tickets]
  group by itin_id, origin, destination



  select top 10 * from [dbo].[Tickets]
  
  select itin_id, ORIGIN, DESTINATION, PASSENGERS, ITIN_FARE
  from [dbo].[Tickets]
  where try_cast(ROUNDTRIP as decimal(10,2)) = 1.0 
  and try_cast(passengers as decimal (10,2))> (select avg(try_cast(passengers as decimal (10,2))) from [dbo].[Tickets])



  --with common table expression (cte)

  with cte as (select ITIN_ID, ORIGIN, DESTINATION, PASSENGERS, ITIN_FARE
  from [dbo].[Tickets]
  where try_cast(roundtrip as decimal(10,2)) = 1.0)
  select itin_id, origin, DESTINATION, PASSENGERS, ITIN_FARE 
  from cte
  where try_cast(itin_fare as decimal(10,2)) > 500.0 and try_cast(passengers as decimal(10,2))> 5.0
  order by passengers, itin_fare desc


----case when statements
select ITIN_ID, ORIGIN, DESTINATION, PASSENGERS, ITIN_FARE,
case
	when ITIN_FARE < 300 then 'Low Fare'
	when ITIN_FARE between 300 and 600 then 'Medium Fare'
	when ITIN_FARE > 600 then 'High Fare'
	else 'Unknown'
end as Fare_Category
From [dbo].[TICKETS1]



---String functions---

select CONCAT(ORIGIN_CITY_NAME, DEST_AIRPORT_ID) from[dbo].[Flights]

---CONCAT
select CONCAT(ORIGIN_CITY_NAME, DEST_AIRPORT_ID) from[dbo].[Flights]

--TRIM
select SUBSTRING (TRIM('"' FROM ORIGIN_CITY_NAME), 1, 3) from[dbo].[Flights]

--SUBSTRING
SELECT SUBSTRING (ORIGIN_CITY_NAME, 1, 4) from[dbo].[Flights]


---CHAR INDEX
select SUBSTRING(OCCUPANCY_RATE,1, CHARINDEX (',',OCCUPANCY_RATE)-1) AS AIR_TIME,OCCUPANCY_RATE from[dbo].[Flights]




SELECT TRY_CAST(FL_DATE AS DATE) AS FL_DATE, OP_CARRIER, TAIL_NUM, OP_CARRIER_FL_NUM, ORIGIN_AIRPORT_ID, ORIGIN,
CONCAT((TRIM('"' FROM ORIGIN_CITY_NAME)), ',', (TRIM('"' FROM DEST_AIRPORT_ID))) AS ORIGIN_CITY_NAME,
DESTINATION AS DEST_AIRPORT_ID, DEST_CITY_NAME AS DESTINATION,
CONCAT((TRIM('"' FROM DEP_DELAY)), ',', (TRIM('"' FROM ARR_DELAY))) AS DEST_CITY_NAME,
CAST(TRY_CAST(CANCELLED AS DECIMAL (10,2)) AS INT) AS DEP_DELAY,
CAST(TRY_CAST(AIR_TIME AS DECIMAL (10,2)) AS INT) AS ARR_DELAY,
CAST(TRY_CAST(DISTANCE AS DECIMAL (10,2)) AS INT) AS CANCELLED,
SUBSTRING(OCCUPANCY_RATE,1, CHARINDEX (',',OCCUPANCY_RATE)-1) AS AIR_TIME, 
SUBSTRING(OCCUPANCY_RATE,
		CHARINDEX (',',OCCUPANCY_RATE)+1, CHARINDEX(',', OCCUPANCY_RATE,CHARINDEX(',', OCCUPANCY_RATE)+1) 
		- CHARINDEX(',', OCCUPANCY_RATE)-1) AS DISTANCE,
SUBSTRING(
        OCCUPANCY_RATE,
        CHARINDEX(',', OCCUPANCY_RATE, CHARINDEX(',', OCCUPANCY_RATE) + 1) + 1,
        LEN(OCCUPANCY_RATE)
    ) AS OCCUPANCY_RATE
FROM [dbo].[Flights]



--Data cleaning Handling NULL, deduplication, 
--Handling missing values
--Remove duplicates using distinct, Group by
--Create views, tables, stored procedures, drop, delete, alter and add

SELECT * FROM [dbo].[TICKETS1]
WHERE PASSENGERS IS NULL


SELECT * FROM [dbo].[TICKETS1] 
WHERE PASSENGERS IS NOT NULL


SELECT *, ISNULL(PASSENGERS, 0) AS PASSENGER1
FROM [dbo].[TICKETS1] 
WHERE PASSENGERS IS NULL

--DE-DUPLICATION
SELECT PASSENGERS FROM [dbo].[TICKETS1] 

SELECT DISTINCT ITIN_ID FROM [dbo].[TICKETS1] 

SELECT PASSENGERS FROM [dbo].[TICKETS1] 
GROUP BY PASSENGERS



SELECT COUNT (*) PASSENGERS FROM [dbo].[TICKETS1] 
GROUP BY PASSENGERS
HAVING COUNT (*) >1

-Create views, tables, stored procedures, drop, delete, alter and add

CREATE VIEW PASS AS

SELECT COUNT(*) AS CNT, PASSENGERS FROM [dbo].[TICKETS1]
GROUP BY PASSENGERS
HAVING COUNT(*) > 1


--Alter
TRUNCATE TABLE [TICKETS112]

INSERT INTO [TICKETS112] (
	   [ITIN_ID]
      ,[YEAR]
      ,[QUARTER]
      ,[ORIGIN]
      ,[ORIGIN_COUNTRY]
      ,[ORIGIN_STATE_ABR]
      ,[ORIGIN_STATE_NM]
      ,[ROUNDTRIP]
      ,[REPORTING_CARRIER]
      ,[PASSENGERS]
      ,[ITIN_FARE]
      ,[DESTINATION]
      ,[SEX] )
SELECT

       [ITIN_ID]
      ,[YEAR]
      ,[QUARTER]
      ,[ORIGIN]
      ,[ORIGIN_COUNTRY]
      ,[ORIGIN_STATE_ABR]
      ,[ORIGIN_STATE_NM]
      ,[ROUNDTRIP]
      ,[REPORTING_CARRIER]
      ,[PASSENGERS]
      ,[ITIN_FARE]
      ,[DESTINATION]
      ,[ORIGIN_STATE_ABR] AS [SEX]

  FROM [Training 02].[dbo].[TICKETS1]  


